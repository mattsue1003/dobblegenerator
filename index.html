import React, { useState, useRef, useEffect } from 'react';
import { Upload, Download, RefreshCw, Grid, Image as ImageIcon, Trash2, Settings, Archive } from 'lucide-react';

// --- å‹•æ…‹è¼‰å…¥å¤–éƒ¨è…³æœ¬ (CDN) ---
const useExternalScripts = (urls) => {
  const [loaded, setLoaded] = useState(false);

  useEffect(() => {
    const loadScript = (url) => {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${url}"]`)) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = url;
        script.async = true;
        script.onload = resolve;
        script.onerror = reject;
        document.body.appendChild(script);
      });
    };

    Promise.all(urls.map(loadScript))
      .then(() => setLoaded(true))
      .catch((err) => console.error("Failed to load scripts", err));
  }, [urls]);

  return loaded;
};

// --- Dobble æ•¸å­¸é‚è¼¯ ---
const generateDobbleDeck = (n) => {
  const cards = [];

  // 1. ç”Ÿæˆ n*n å¼µå¡ç‰‡
  for (let i = 0; i < n; i++) {
    for (let j = 0; j < n; j++) {
      const card = [];
      card.push(i + 1);
      for (let k = 0; k < n; k++) {
        const val = (n + 2) + (n * k) + ((i * k + j) % n);
        card.push(val);
      }
      cards.push(card);
    }
  }

  // 2. ç”Ÿæˆ n å¼µå¡ç‰‡
  for (let i = 0; i < n; i++) {
    const card = [];
    card.push(0 + 1);
    for (let j = 0; j < n; j++) {
      const val = (n + 2) + (n * j) + i;
      card.push(val);
    }
    cards.push(card);
  }

  // 3. ç”Ÿæˆ 1 å¼µå¡ç‰‡
  const lastCard = [];
  lastCard.push(0 + 1);
  for (let i = 0; i < n; i++) {
    lastCard.push(i + 1);
  }
  cards.push(lastCard);

  return cards.map(card => {
    let adjustedCard = card.map(val => val - 1);
    while(adjustedCard.length < 8) {
        adjustedCard.push(null); 
    }
    for (let i = adjustedCard.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [adjustedCard[i], adjustedCard[j]] = [adjustedCard[j], adjustedCard[i]];
    }
    return adjustedCard;
  });
};

const DEFAULT_EMOJIS = [
  "ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯",
  "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ”", "ğŸ§", "ğŸ¦", "ğŸ¤", "ğŸ¦†",
  "ğŸ¦…", "ğŸ¦‰", "ğŸ¦‡", "ğŸº", "ğŸ—", "ğŸ´", "ğŸ¦„", "ğŸ", "ğŸ›", "ğŸ¦‹",
  "ğŸŒ", "ğŸ", "ğŸœ", "ğŸ¦Ÿ", "ğŸ¦—", "ğŸ•·", "ğŸ•¸", "ğŸ¦‚", "ğŸ¢", "ğŸ",
  "ğŸ¦", "ğŸ¦–", "ğŸ¦•", "ğŸ™", "ğŸ¦‘", "ğŸ¦", "ğŸ¦", "ğŸ¦€", "ğŸ¡", "ğŸ ",
  "ğŸŸ", "ğŸ¬", "ğŸ³", "ğŸ¦ˆ", "ğŸŠ", "ğŸ…", "ğŸ†", "ğŸ¦“", "ğŸ¦"
];

const DECK_SIZES = [
  { n: 3, count: 13, label: "è¿·ä½ ç‰ˆ (13å¼µå¡)", desc: "éœ€ 13 å¼µç…§ç‰‡" },
  { n: 5, count: 31, label: "æ¨™æº–ç‰ˆ (31å¼µå¡)", desc: "é è¨­æ¨è–¦ï¼éœ€ 31 å¼µç…§ç‰‡" },
  { n: 7, count: 57, label: "å®Œæ•´ç‰ˆ (57å¼µå¡)", desc: "éœ€ 57 å¼µç…§ç‰‡" }
];

const CARDS_PER_PAGE = 6;

export default function DobbleGenerator() {
  const [images, setImages] = useState([]);
  const [deck, setDeck] = useState([]);
  const [logoImage, setLogoImage] = useState(null);
  const [deckSize, setDeckSize] = useState(DECK_SIZES[1]); 
  const [isProcessing, setIsProcessing] = useState(false);
  const [loadingProgress, setLoadingProgress] = useState(0);
  const [processStatus, setProcessStatus] = useState("");
  const printRef = useRef(null);

  // è¼‰å…¥ PDF èˆ‡ ZIP ç›¸é—œå¥—ä»¶
  const scriptsLoaded = useExternalScripts([
    "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"
  ]);

  const handleImageUpload = (e) => {
    const files = Array.from(e.target.files);
    const newImages = files.map(file => ({
      id: Math.random().toString(36).substr(2, 9),
      url: URL.createObjectURL(file),
      file: file
    }));
    setImages(prev => [...prev, ...newImages]);
  };

  const handleLogoUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      setLogoImage(URL.createObjectURL(file));
    }
  };

  const clearImages = () => {
    setImages([]);
    setDeck([]);
  };

  const generateDeck = () => {
    const rawDeck = generateDobbleDeck(deckSize.n);
    setDeck(rawDeck);
  };

  // çµ±ä¸€çš„å…§å®¹æ¸²æŸ“é‚è¼¯
  const getSymbolContent = (symbolIndex, isPrint = false) => {
    if (symbolIndex === null) return <div className="w-full h-full bg-slate-50/20"></div>;

    const hasImage = images[symbolIndex];
    
    // å®¹å™¨æ¨£å¼ï¼šä½¿ç”¨ Flexbox å¼·åˆ¶ç½®ä¸­
    const containerStyle = {
        width: '100%',
        height: '100%',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        overflow: 'hidden',
        padding: '2px'
    };

    if (hasImage) {
        return (
            <div style={containerStyle}>
                <img 
                    src={images[symbolIndex].url} 
                    alt="symbol" 
                    style={{ 
                        maxWidth: '100%', 
                        maxHeight: '100%', 
                        objectFit: 'contain', // ç¢ºä¿æ¯”ä¾‹ä¸è®Š
                        display: 'block' 
                    }} 
                />
            </div>
        );
    } else {
        const emoji = DEFAULT_EMOJIS[symbolIndex % DEFAULT_EMOJIS.length];
        return (
            <div style={containerStyle}>
                <span style={{ 
                    fontSize: isPrint ? '48px' : '32px', 
                    lineHeight: '1',
                    display: 'block',
                    // é‡å° PDF åˆ—å°æ¨¡å¼ï¼Œå¼·åˆ¶å¾€ä¸Šç§»å‹• 4mm (åŸæœ¬æ˜¯ 2mmï¼Œç¾åœ¨å†åŠ  2mm)
                    position: 'relative',
                    top: isPrint ? '-4mm' : '0' 
                }}>
                    {emoji}
                </span>
            </div>
        );
    }
  };

  // ç”Ÿæˆåœ–ç‰‡è³‡æ–™ (å…±ç”¨å‡½å¼)
  const generateCardImages = async () => {
    if (!window.html2canvas) return [];
    
    const container = printRef.current;
    
    // å°‡å®¹å™¨ç§»åˆ°è¢å¹•å¯è¦‹å€åŸŸå¤–ï¼Œè€Œä¸æ˜¯ display: none
    container.style.position = 'fixed';
    container.style.left = '0';
    container.style.top = '0';
    container.style.zIndex = '-1000';
    container.style.opacity = '1'; // ç¢ºä¿å¯è¦‹æ‰èƒ½æˆªåœ–
    container.style.display = 'block';

    const cardElements = Array.from(container.querySelectorAll('.print-card-wrapper'));
    const generatedImages = [];

    for (let i = 0; i < cardElements.length; i++) {
        setProcessStatus(`æ­£åœ¨è™•ç†ç¬¬ ${i + 1} / ${cardElements.length} å¼µå¡ç‰‡...`);
        setLoadingProgress(Math.round(((i) / cardElements.length) * 100));

        const canvas = await window.html2canvas(cardElements[i], {
            scale: 2, // è§£æåº¦
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
        });
        
        generatedImages.push(canvas.toDataURL('image/jpeg', 0.9));
    }

    // å¾©åŸ
    container.style.display = 'none';
    return generatedImages;
  };

  const downloadPDF = async () => {
    if (deck.length === 0 || !scriptsLoaded) return;
    setIsProcessing(true);
    setLoadingProgress(0);

    try {
        const cardImages = await generateCardImages();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        setProcessStatus("æ­£åœ¨æ’ç‰ˆ PDF...");
        
        // A4 æ’ç‰ˆåƒæ•¸
        const pos = [
            { x: 10, y: 10 }, { x: 110, y: 10 },
            { x: 10, y: 105 }, { x: 110, y: 105 },
            { x: 10, y: 200 }, { x: 110, y: 200 }
        ];

        for (let i = 0; i < cardImages.length; i++) {
            const pageIndex = Math.floor(i / CARDS_PER_PAGE);
            const posIndex = i % CARDS_PER_PAGE;

            if (posIndex === 0 && pageIndex > 0) doc.addPage();
            
            doc.addImage(cardImages[i], 'JPEG', pos[posIndex].x, pos[posIndex].y, 90, 90);
        }

        doc.save(`æ¡ŒéŠå¡ç‰Œ_${deckSize.count}å¼µç‰ˆ.pdf`);
    } catch (e) {
        console.error(e);
        alert("ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦");
    }
    
    setIsProcessing(false);
    setProcessStatus("");
  };

  const downloadZIP = async () => {
    if (deck.length === 0 || !scriptsLoaded) return;
    setIsProcessing(true);
    setLoadingProgress(0);

    try {
        const cardImages = await generateCardImages();
        const zip = new window.JSZip();
        
        setProcessStatus("æ­£åœ¨å£“ç¸®åœ–ç‰‡...");

        cardImages.forEach((dataUrl, i) => {
            const base64Data = dataUrl.replace(/^data:image\/jpeg;base64,/, "");
            zip.file(`card_${i + 1}.jpg`, base64Data, { base64: true });
        });

        const content = await zip.generateAsync({ type: "blob" });
        window.saveAs(content, `æ¡ŒéŠåœ–æª”åŒ…_${deckSize.count}å¼µ.zip`);

    } catch (e) {
        console.error(e);
        alert("å£“ç¸®å¤±æ•—ï¼Œè«‹é‡è©¦");
    }

    setIsProcessing(false);
    setProcessStatus("");
  };

  return (
    <div className="min-h-screen bg-amber-50 font-sans text-slate-800 pb-20">
      {/* Header */}
      <header className="bg-orange-600 text-white p-6 shadow-lg border-b-4 border-orange-800">
        <div className="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
          <div className="flex items-center gap-4">
            <div className="bg-white p-2 rounded-lg text-orange-600">
                <Grid size={40} strokeWidth={2.5} />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold tracking-wide">æ¨‚é½¡æ¡ŒéŠç”Ÿæˆå™¨</h1>
              <p className="text-orange-100 font-medium text-lg">å¤§åœ–ç¤º â€¢ æ¸…æ™°ä¹å®®æ ¼ â€¢ A4 å…­å¼µåˆ—å°</p>
            </div>
          </div>
          <div className="flex gap-3">
            <button 
              onClick={clearImages}
              className="px-6 py-3 bg-orange-700 hover:bg-orange-800 rounded-xl flex items-center gap-2 transition text-lg font-bold border-2 border-orange-900 shadow-sm"
            >
              <RefreshCw size={24} /> é‡ç½®
            </button>
            <button 
              onClick={generateDeck}
              className="px-6 py-3 bg-white text-orange-700 font-extrabold rounded-xl hover:bg-orange-50 flex items-center gap-2 shadow-lg transition text-lg border-b-4 border-orange-200 active:border-b-0 active:translate-y-1"
            >
              <Grid size={24} /> ç”Ÿæˆç‰Œçµ„
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-6 space-y-8">
        
        {/* Settings & Upload Section */}
        <section className="bg-white p-8 rounded-2xl shadow-md border-2 border-amber-200">
          
          {/* Deck Size Selector */}
          <div className="mb-8 p-6 bg-amber-50 rounded-xl border-2 border-amber-100">
            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-amber-800">
                <Settings size={24} />
                æ­¥é©Ÿ 0: é¸æ“‡å¡ç‰‡æ•¸é‡
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {DECK_SIZES.map((size) => (
                    <button
                        key={size.n}
                        onClick={() => setDeckSize(size)}
                        className={`p-4 rounded-xl border-2 text-left transition relative ${
                            deckSize.n === size.n 
                            ? 'border-orange-500 bg-white shadow-md ring-2 ring-orange-200' 
                            : 'border-slate-200 bg-white hover:border-orange-300'
                        }`}
                    >
                        <div className="font-bold text-lg text-slate-800">{size.label}</div>
                        <div className="text-sm text-slate-500 mt-1">{size.desc}</div>
                        {deckSize.n === size.n && (
                            <div className="absolute top-2 right-2 w-4 h-4 bg-orange-500 rounded-full"></div>
                        )}
                    </button>
                ))}
            </div>
          </div>

          <h2 className="text-2xl font-bold mb-6 flex items-center gap-3 text-amber-800">
            <div className="bg-amber-100 p-2 rounded-full"><ImageIcon className="text-amber-600" size={28} /></div>
            æ­¥é©Ÿ 1: ä¸Šå‚³åœ–æ¡ˆ
          </h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div className="space-y-4">
              <label className="block text-lg font-bold text-slate-700">
                éŠæˆ²åœ–æ¡ˆ (ç›®å‰å·²ä¸Šå‚³ {images.length} å¼µ)
              </label>

              {/* æ™ºæ…§ç‹€æ…‹é¡¯ç¤º */}
              <div className="bg-slate-50 p-4 rounded-xl border-2 border-slate-200">
                 <div className="pt-2 border-t border-slate-200">
                    <p className="font-bold text-orange-700 text-lg">ç›®å‰ç›®æ¨™ï¼šè£½ä½œ {deckSize.count} å¼µå¡ç‰‡</p>
                    <p className="text-sm text-slate-600 mt-2 font-medium">
                        {images.length < deckSize.count 
                            ? `âš ï¸ æ‚¨çš„ç…§ç‰‡é‚„å°‘ ${deckSize.count - images.length} å¼µã€‚` 
                            : "âœ… ç…§ç‰‡å……è¶³ï¼"}
                    </p>
                    <p className="text-xs text-slate-500 mt-1">
                        {images.length < deckSize.count 
                           ? "ä¸ç”¨æ“”å¿ƒï¼Œé»æ“Šã€Œç”Ÿæˆç‰Œçµ„ã€å¾Œï¼Œä¸è¶³çš„éƒ¨åˆ†æœƒè‡ªå‹•è®Šæˆå¯æ„›çš„ Emoji åœ–ç¤ºã€‚" 
                           : "æ‰€æœ‰åœ–æ¡ˆéƒ½å°‡ä½¿ç”¨æ‚¨çš„ç…§ç‰‡ï¼Œä¸æœƒå‡ºç¾ Emojiã€‚"}
                    </p>
                 </div>
              </div>

              <div className="relative group border-4 border-dashed border-amber-300 rounded-2xl p-10 text-center hover:border-orange-500 hover:bg-orange-50 transition cursor-pointer bg-amber-50/50">
                <input 
                  type="file" 
                  multiple 
                  accept="image/*" 
                  onChange={handleImageUpload}
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />
                <Upload className="mx-auto text-amber-400 mb-4 group-hover:text-orange-500" size={48} />
                <p className="text-slate-600 text-xl font-medium">é»æ­¤é¸æ“‡ç…§ç‰‡</p>
                <p className="text-slate-400 mt-2">å¯ä¸€æ¬¡å¤šé¸ (å»ºè­° {deckSize.count} å¼µä»¥ä¸Š)</p>
              </div>
            </div>

            <div className="space-y-4">
              <label className="block text-lg font-bold text-slate-700">
                ä¸­é–“è£é£¾åœ– (Logo)
              </label>
               <p className="text-sm text-slate-500">é€™å¼µåœ–æœƒæ”¾åœ¨æ¯å¼µå¡ç‰‡çš„æ­£ä¸­é–“ï¼Œä¸åƒèˆ‡éŠæˆ²ï¼Œç´”è£é£¾ã€‚</p>
              <div className="relative group border-4 border-dashed border-slate-300 rounded-2xl p-4 flex items-center justify-center h-[200px] hover:border-orange-400 hover:bg-orange-50 transition cursor-pointer bg-slate-50">
                 <input 
                  type="file" 
                  accept="image/*" 
                  onChange={handleLogoUpload}
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />
                {logoImage ? (
                  <img src={logoImage} alt="Logo" className="h-full w-auto object-contain" />
                ) : (
                  <div className="text-center">
                    <div className="bg-slate-200 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400">
                        <span className="text-3xl font-bold">?</span>
                    </div>
                    <span className="text-slate-500 font-medium">é»æ­¤ä¸Šå‚³ Logo</span>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Image Preview Strip */}
          {images.length > 0 && (
            <div className="mt-8">
              <div className="flex justify-between items-end mb-3">
                  <p className="text-lg font-bold text-slate-700">å·²ä¸Šå‚³é è¦½ (å¯é»æ“Šåˆªé™¤):</p>
                  <button onClick={() => setImages([])} className="text-red-500 text-sm hover:underline">å…¨éƒ¨åˆªé™¤</button>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-4 scrollbar-thin scrollbar-thumb-amber-300">
                {images.map((img) => (
                  <div key={img.id} className="relative flex-shrink-0 w-24 h-24 border-2 border-slate-200 rounded-xl overflow-hidden bg-white shadow-sm group">
                    <img src={img.url} className="w-full h-full object-cover" />
                    <button 
                      onClick={() => setImages(images.filter(i => i.id !== img.id))}
                      className="absolute inset-0 bg-black/50 text-white opacity-0 group-hover:opacity-100 flex items-center justify-center transition"
                    >
                      <Trash2 size={24} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </section>

        {/* Deck Preview Section */}
        {deck.length > 0 && (
          <section className="space-y-8">
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row items-center justify-between sticky top-4 z-10">
              <h2 className="text-2xl font-bold flex items-center gap-3 text-slate-800">
                <Grid className="text-orange-600" size={28} /> 
                æ­¥é©Ÿ 2: é è¦½ç‰Œçµ„ ({deck.length} å¼µ)
              </h2>
              
              <div className="flex gap-2">
                 {/* ZIP Download Button */}
                <button 
                    onClick={downloadZIP}
                    disabled={isProcessing || !scriptsLoaded}
                    className={`px-4 py-3 rounded-xl font-bold text-lg flex items-center gap-2 shadow-lg transition transform active:scale-95 ${
                    isProcessing || !scriptsLoaded
                    ? 'bg-slate-300 text-slate-500 cursor-not-allowed' 
                    : 'bg-blue-600 text-white hover:bg-blue-700 border-b-4 border-blue-800'
                    }`}
                >
                    {isProcessing ? `è™•ç†ä¸­ ${loadingProgress}%` : (
                    !scriptsLoaded ? 'è¼‰å…¥ä¸­...' : <><Archive size={20} /> ä¸‹è¼‰åœ–ç‰‡åŒ…(ZIP)</>
                    )}
                </button>

                {/* PDF Download Button */}
                <button 
                    onClick={downloadPDF}
                    disabled={isProcessing || !scriptsLoaded}
                    className={`px-6 py-3 rounded-xl font-bold text-lg flex items-center gap-3 shadow-lg transition transform active:scale-95 ${
                    isProcessing || !scriptsLoaded
                    ? 'bg-slate-300 text-slate-500 cursor-not-allowed' 
                    : 'bg-green-600 text-white hover:bg-green-700 border-b-4 border-green-800'
                    }`}
                >
                    {isProcessing ? `${processStatus}` : (
                    !scriptsLoaded ? 'è¼‰å…¥ä¸­...' : <><Download size={24} /> ä¸‹è¼‰ PDF</>
                    )}
                </button>
              </div>
            </div>

            {/* Display Grid (Preview on Screen) */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-8">
              {deck.map((card, cardIndex) => (
                <div key={cardIndex} className="bg-white rounded-2xl shadow-lg p-3 aspect-square flex flex-col items-center border-4 border-slate-200 relative">
                  <div className="absolute -top-3 -left-3 bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold shadow-md z-10">
                    {cardIndex + 1}
                  </div>
                  
                  <div className="grid grid-cols-3 grid-rows-3 gap-1 w-full h-full bg-slate-100 p-1 rounded-lg">
                    {[0, 1, 2, 3].map(i => (
                      <div key={`c-${cardIndex}-top-${i}`} className="bg-white rounded-lg overflow-hidden flex items-center justify-center border border-slate-200 shadow-sm relative">
                        {getSymbolContent(card[i])}
                      </div>
                    ))}
                    
                    <div className="bg-amber-50 rounded-lg overflow-hidden flex items-center justify-center border-2 border-amber-200 relative shadow-inner">
                       {logoImage ? (
                         <img src={logoImage} className="w-full h-full object-contain" />
                       ) : (
                         <div className="text-center">
                            <span className="text-amber-400 font-black text-xs">LOGO</span>
                         </div>
                       )}
                    </div>

                    {[4, 5, 6, 7].map(i => (
                      <div key={`c-${cardIndex}-bottom-${i}`} className="bg-white rounded-lg overflow-hidden flex items-center justify-center border border-slate-200 shadow-sm relative">
                        {getSymbolContent(card[i])}
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}
      </main>

      {/* Hidden Print Container - ä½¿ç”¨é«˜å°æ¯”ã€æ¨™æº– HTML Flow ä½ˆå±€ä»¥åˆ©æˆªåœ– */}
      <div 
        ref={printRef} 
        style={{ 
            position: 'absolute', 
            top: 0, 
            left: '-9999px', // ç§»å‡ºç•«é¢
            width: '90mm',   // åªéœ€å®šç¾©å¯¬åº¦ï¼Œå…§å®¹æœƒè¢«è¤‡è£½
            display: 'none'  // åˆå§‹éš±è—ï¼Œç”Ÿæˆæ™‚æœƒè¢«è¨­ç‚º block
        }} 
      >
        {deck.map((card, cardIndex) => (
          <div 
            key={`print-${cardIndex}`} 
            className="print-card-wrapper"
            style={{ 
              width: '90mm',
              height: '90mm', 
              margin: '0',
              padding: '0',
              backgroundColor: '#fff',
              border: '1mm solid #000000', // å¤–æ¡†æ”¹ç‚º 1mm
              borderRadius: '6mm',
              overflow: 'hidden',
              boxSizing: 'border-box',
              display: 'block' // ç¢ºä¿æ˜¯ block
            }}
          >
            {/* ä½¿ç”¨ Flex Grid æ¨¡æ“¬ä¹å®®æ ¼ï¼Œç¢ºä¿ç›¸å®¹æ€§ */}
            <div style={{ 
                width: '100%', 
                height: '100%', 
                display: 'flex', 
                flexWrap: 'wrap'
            }}>
                {/* ç¬¬ä¸€åˆ— */}
                {[0, 1, 2].map(i => (
                    <div key={`p-c-${i}`} style={{ width: '33.33%', height: '33.33%', border: '1px solid #000', boxSizing: 'border-box' }}>
                         {getSymbolContent(card[i], true)}
                    </div>
                ))}
                {/* ç¬¬äºŒåˆ— (å« Logo) */}
                <div style={{ width: '33.33%', height: '33.33%', border: '1px solid #000', boxSizing: 'border-box' }}>
                     {getSymbolContent(card[3], true)}
                </div>
                <div style={{ width: '33.33%', height: '33.33%', border: '1px solid #000', boxSizing: 'border-box', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                     {logoImage ? (
                        <img src={logoImage} style={{ maxWidth: '90%', maxHeight: '90%', objectFit: 'contain' }} />
                     ) : (
                        <span style={{ fontSize: '12px', fontWeight: 'bold', color: '#ccc' }}>LOGO</span>
                     )}
                </div>
                <div style={{ width: '33.33%', height: '33.33%', border: '1px solid #000', boxSizing: 'border-box' }}>
                     {getSymbolContent(card[4], true)}
                </div>
                {/* ç¬¬ä¸‰åˆ— */}
                {[5, 6, 7].map(i => (
                    <div key={`p-c-${i}`} style={{ width: '33.33%', height: '33.33%', border: '1px solid #000', boxSizing: 'border-box' }}>
                         {getSymbolContent(card[i], true)}
                    </div>
                ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
